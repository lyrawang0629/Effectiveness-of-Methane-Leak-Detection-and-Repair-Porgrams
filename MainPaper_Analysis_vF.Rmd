---
title: "MainPaper_Analysis"
author: "Jiayang (Lyra) Wang"
date: "12/1/2021"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
rm(list = ls())
```

This document contains codes for the analysis presented in the main text of the "Large-Scale Controlled Experiment Demonstrate Effectiveness of Methane Leak Detection and Repair Programs at Oil and Gas Facilities". 

You should be able to regenerate every number mentioned in the main text with the following code. If you have any questions, please reach out to Lyra Wang - lyrawang.work@gmail.com

```{r}
# load packages
library(tidyr)
library(dplyr)
library(readxl)
library(ggplot2)
```

```{r}
# import data
dataRaw <- read_xlsx("~/Wang_FEMPEA_SI_v2.xlsx", sheet = "Component_Emissions")

siteRaw <- read_xlsx("~/Wang_FEMPEA_SI_v2.xlsx", sheet = "Site_Emissions")

tagged <- read_xlsx("~/Wang_FEMPEA_SI_v2.xlsx", sheet = "Tagged_Emissions")

repaired <- read_xlsx("~/Wang_FEMPEA_SI_v2.xlsx", sheet = "Repaired_Analysis")
```

```{r}
# data selection and engineering 
data <- dataRaw %>% 
  # select August 2018 and August 2019 surveys for component level comparison analysis
  filter(Survey == "Survey 1" | Survey == "Survey 5") 

site <- siteRaw %>% 
  # select August 2018 and August 2019 surveys for site level comparison analysis
  filter(Survey == "Survey 1" | Survey == "Survey 5") %>%
  # add in variable on 1) whether a site is oil/gas site and 2) whether a site is multi-well or single well site
  mutate(OilGas = ifelse(grepl("Oil", Site.Type), "Oil", "Gas"), MWSW = ifelse(grepl("MW", Site.Type), "MW", "SW"), Site.Type.All = paste(OilGas, " ", MWSW)) 

siteCount <- site %>% # distribution of types of sites in the sample
  group_by(Survey, Site.Type) %>% # group distribution by survey and type of sites
  tally() # show distribution

```

```{r}
# create Aug18 and Aug19 component level data set and calculate the cumulative distribution of emissions as a function of rank-ordered cumulative number of emitters
Aug18 <- data %>% 
  # select component emissions from August 2018 initial survey only
  filter(Survey == "Survey 1") %>%
  # rank emissions from largest to smallest 
  arrange(-`Emission (kg/d)`) %>% 
  # calculate cumulative distribution of emissions
  mutate(EmissionPerc = cumsum(`Emission (kg/d)`)/sum(`Emission (kg/d)`))

Aug18 <- Aug18 %>% 
  # calculate the cumulative distribution of emitters
  mutate(EmitterPerc = seq.int(nrow(Aug18))/nrow(Aug18))

Aug19 <- data %>% 
  # select component emissions from August 2019 initial survey only
  filter(Survey == "Survey 5") %>% 
  # rank emissions from largest to smallest 
  arrange(-`Emission (kg/d)`) %>% 
  # calculate cumulative distribution of emissions
  mutate(EmissionPerc = cumsum(`Emission (kg/d)`)/sum(`Emission (kg/d)`))

Aug19 <- Aug19 %>% 
  # calculate the cumulative distribution of emitters
  mutate(EmitterPerc = seq.int(nrow(Aug19))/nrow(Aug19))
```

The codes below present numbers in the Results section in sequential order. 

```{r}
# Results section:
# Vent emissions, on average, constitute a disproportionate share (>69%) of total methane emissions

data %>% # count of emitters at each survey
  group_by(Survey) %>% # group distribution by survey and type of sites
  tally() # show distribution

data %>% # mean of emissions at each survey
  group_by(Survey) %>% 
  summarise(Average = mean(`Emission (kg/d)`))

Aug18 %>% # count of emitters >100 kg/d
  filter(`Emission (kg/d)`>100) %>% 
  summarise(Count = nrow(.))

Aug18 %>% # % contribution of emitters >100 kg/d
  summarise(Perc = sum(`Emission (kg/d)`[`Emission (kg/d)`>100])/sum(`Emission (kg/d)`))

Aug19 %>% #count of emitters >100
  filter(`Emission (kg/d)`>100) %>% 
  summarise(Count = nrow(.))

Aug19 %>% # % contribution of emitters >100 kg/d
  summarise(Perc = sum(`Emission (kg/d)`[`Emission (kg/d)`>100])/sum(`Emission (kg/d)`))

Aug18 %>% # 90% of emissions from emitters emitting at least
  # select top emitters that together made up 90% of emissions
  filter(EmissionPerc > 0.9) %>% 
  # select the cutoff row of 90% cumulative emissions
  filter(row_number() == 1) %>% 
  # select the emission size of the cutoff emitter
  select(`Emission (kg/d)`)

Aug19 %>% # 90% of emissions from emitters emitting at least
  # select top emitters that together made up 90% of emissions
  filter(EmissionPerc > 0.9) %>% 
  # select the cutoff row of 90% cumulative emissions
  filter(row_number() == 1) %>% 
  # select the emission size of the cutoff emitter
  select(`Emission (kg/d)`)

Aug18 %>% # top emitters that together contribute to 90% of emissions make up of % of emitter
  # select top emitters that make up of 90% of emissions
  filter(EmissionPerc < 0.9) %>% 
  # % of selected top emitters to total count of emitters
  nrow()/nrow(Aug18)

Aug19 %>% # top emitters that together contribute to 90% of emissions make up of % of emitter
  # select top emitters that make up of 90% of emissions
  filter(EmissionPerc < 0.9) %>% 
  # % of selected top emitters to total count of emitters
  nrow()/nrow(Aug19)

Aug18 %>% # top 5% of components emitting x% of total emissions
  # select the emitter closest to 5% of total emitters by calculate absolute difference between cumulative emitter distribution and 0.05
  arrange(abs(EmitterPerc-0.05)) %>% 
  # select the row of the 5% cutoff emitter
  filter(row_number() == 1) %>% 
  # select the cumulative emission percentage of the cutoff emitter
  select(EmissionPerc)

Aug19 %>% # top 5% of components emitting x% of total emissions
  # select the emitter closest to 5% of total emitters by calculate absolute difference between cumulative emitter distribution and 0.05
  arrange(abs(EmitterPerc-0.05)) %>% 
  # select the row of the 5% cutoff emitter
  filter(row_number() == 1) %>% 
  # select the cumulative emission percentage of the cutoff emitter
  select(EmissionPerc)

Aug18 %>% # common components in the top 5% of emitters
  # select the top 5% of emitters
  filter(EmitterPerc < 0.05) %>% 
  # group the selected emitters by component
  group_by(`Emitting Component`) %>% 
  # count each component
  tally()

Aug18 %>% # emission contribution of tank related open-ended lines that are in the top 5% emitters
  # select top 5% emitters that are also tank related open-ended lines
  filter(EmitterPerc < 0.05 & `Emitting Component` == "Open-Ended Line (Tank)") %>%
  # calculate their emissions to total emissions from all emitters in Aug 2018 Survey
  summarise(Perc = sum(`Emission (kg/d)`[`Emitting Component` == "Open-Ended Line (Tank)"])/sum(Aug18$`Emission (kg/d)`))

Aug19 %>% # common components in the top 5% of emitters
  # select the top 5% of emitters
  filter(EmitterPerc < 0.05) %>% 
  # group the selected emitters by component
  group_by(`Emitting Component`) %>% 
  # count each component
  tally() 

Aug19 %>% # emission contribution of tank related open-ended lines that are in the top 5% emitters
  # select top 5% emitters that are also tank related open-ended lines
  filter(EmitterPerc < 0.05 & `Emitting Component` == "Open-Ended Line (Tank)") %>%
  # calculate their emissions to total emissions from all emitters in Aug 2019 Survey
  summarise(Perc = sum(`Emission (kg/d)`[`Emitting Component` == "Open-Ended Line (Tank)"])/sum(Aug19$`Emission (kg/d)`))

Aug19 %>% # emitter % of flange/connector, pneumatics, and valves
  # select flange/connector, pneumatics, and valves
  filter(`Emitting Component` %in% c("Flange/Connector", "Pneumatics", "Valves")) %>%
  # calculate the emitter count % to total count %
  summarise(n()/nrow(Aug19))

Aug19 %>% # emission % of flange/connector, pneumatics, and valves
  # select flange/connector, pneumatics, and valves
  filter(`Emitting Component` %in% c("Flange/Connector", "Pneumatics", "Valves")) %>%
  # calculate their emissions to total emissions
  summarise(sum(`Emission (kg/d)`)/sum(Aug19$`Emission (kg/d)`))

Aug19 %>% # emitter % of thief hatch and tank related open-ended lines
  # select thief hatch and tank related open-ended lines
  filter(`Emitting Component` %in% c("Thief Hatch", "Open-Ended Line (Tank)")) %>%
  # calculate the emitter count % to total count %
  summarise(n()/nrow(Aug19))

Aug19 %>% # emitter % of thief hatch and tank related open-ended lines
  # select thief hatch and tank related open-ended lines
  filter(`Emitting Component` %in% c("Thief Hatch", "Open-Ended Line (Tank)")) %>%
  # calculate their emissions to total emissions
  summarise(sum(`Emission (kg/d)`)/sum(Aug19$`Emission (kg/d)`))

Aug19 %>% # emission % of tank related emitters
  # select tank related emitters
  filter(`Tank Relation` == "Yes") %>% 
  # calculate their emissions to total emissions
  summarise(sum(`Emission (kg/d)`)/sum(Aug19$`Emission (kg/d)`))

Aug18 %>% # emissions % of leak and vent emissions
  # group emitters by leak and vent emissions
  group_by(`Vent/Leak`) %>% 
  # calculate their emissions to total emissions
  summarise(sum(`Emission (kg/d)`)/sum(Aug18$`Emission (kg/d)`))

Aug19 %>% # emissions % of leak and vent emissions
  # group emitters by leak and vent emissions
  group_by(`Vent/Leak`) %>% 
  # calculate their emissions to total emissions
  summarise(sum(`Emission (kg/d)`)/sum(Aug19$`Emission (kg/d)`))

# leak emissions reduction from 2018 to 2019
(sum(Aug19$`Emission (kg/d)`[Aug19$`Vent/Leak` == "Leak"]) - sum(Aug18$`Emission (kg/d)`[Aug18$`Vent/Leak` == "Leak"]))/sum(Aug18$`Emission (kg/d)`[Aug18$`Vent/Leak` == "Leak"])

# vent emissions reduction from 2018 to 2019
(sum(Aug19$`Emission (kg/d)`[Aug19$`Vent/Leak` == "Vent"]) - sum(Aug18$`Emission (kg/d)`[Aug18$`Vent/Leak` == "Vent"]))/sum(Aug18$`Emission (kg/d)`[Aug18$`Vent/Leak` == "Vent"])

# total emissions reduction from 2018 to 2019
(sum(Aug18$`Emission (kg/d)`) - sum(Aug19$`Emission (kg/d)`))/sum(Aug18$`Emission (kg/d)`)

# vent emissions reduction over total emissions reduction
(sum(Aug19$`Emission (kg/d)`[Aug19$`Vent/Leak` == "Vent"]) - sum(Aug18$`Emission (kg/d)`[Aug18$`Vent/Leak` == "Vent"]))/(sum(Aug19$`Emission (kg/d)`) - sum(Aug18$`Emission (kg/d)`))

Aug18 %>% # count of leak and vent emissions
  # group emitters by leak and vent
  group_by(`Vent/Leak`) %>% 
  # count number of leak and vent emissions
  tally()

Aug19 %>% # count of leak and vent emissions
  # group emitters by leak and vent
  group_by(`Vent/Leak`) %>% 
  # count number of leak and vent emissions
  tally()

Aug18 %>% # % of leak emissions to total emissions
  summarise(LeakMean = mean(`Emission (kg/d)`[`Vent/Leak` == "Leak"]))

Aug19 %>% # % of leak emisisons to total emissions
  summarise(LeakMean = mean(`Emission (kg/d)`[`Vent/Leak` == "Leak"]))

# emissions reduction from large leak emissions (>100 kg/d) over total emissions reduction - showing that reductions from large leaks is the main driver of leak emissions reduction
(sum(Aug18$`Emission (kg/d)`[Aug18$`Vent/Leak` == "Leak" & Aug18$`Emission (kg/d)` > 100]) - sum(Aug19$`Emission (kg/d)`[Aug19$`Vent/Leak` == "Leak" & Aug19$`Emission (kg/d)` > 100]))/(sum(Aug18$`Emission (kg/d)`[Aug18$`Vent/Leak` == "Leak"]) - sum(Aug19$`Emission (kg/d)`[Aug19$`Vent/Leak` == "Leak"]))

Aug18 %>% # large leak emissions - count and contribution to leak emissions
  # select large leak emissions (those > 100 kg/d)
  filter(`Emission (kg/d)` > 100 & `Vent/Leak` == "Leak") %>% 
  # calculate the count and contribution to leak emissions
  summarise(Count = n(), Perc = sum(`Emission (kg/d)`)/sum(Aug18$`Emission (kg/d)`[Aug18$`Vent/Leak` == "Leak"]))

Aug19 %>% # large leak emissions - count and contribution to leak emissions
  # select large leak emissions (those > 100 kg/d)
  filter(`Emission (kg/d)` > 100 & `Vent/Leak` == "Leak") %>% 
  # calculate the count and contribution to leak emissions
  summarise(Count = n(), Perc = sum(`Emission (kg/d)`)/sum(Aug19$`Emission (kg/d)`[Aug19$`Vent/Leak` == "Leak"]))

# emissions reduction from large leak emissions (>100 kg/d) from 2018 to 2019
(sum(Aug18$`Emission (kg/d)`[Aug18$`Emission (kg/d)` > 100 & Aug18$`Vent/Leak` == "Leak"]) - sum(Aug19$`Emission (kg/d)`[Aug19$`Emission (kg/d)` > 100 & Aug19$`Vent/Leak` == "Leak"]))/sum(Aug18$`Emission (kg/d)`[Aug18$`Emission (kg/d)` > 100 & Aug18$`Vent/Leak` == "Leak"])

# The follow code calculate the top 5% leak emitter's contribution to total leak emissions (note this is different than top 5% of all emitters)

###
# calculate cumulative emissions contribution of each leak emitter to total leak emissions
Aug18Leak <- Aug18 %>% 
  # select leak emissions
  filter(`Vent/Leak` == "Leak") %>% 
  # calculate cumulative percentage of leak emissions
  mutate(EmissionPerc = cumsum(`Emission (kg/d)`)/sum(`Emission (kg/d)`))

# calculate cumulative emitter contribution of leak emissions
Aug18Leak <- Aug18Leak %>% 
  mutate(EmitterPerc = seq.int(nrow(Aug18Leak))/nrow(Aug18Leak))

# leak emissions contribution from top 5% of total leak emissions
sum(Aug18Leak$`Emission (kg/d)`[Aug18Leak$EmitterPerc < 0.05 & Aug18Leak$`Vent/Leak` == "Leak"])/sum(Aug18Leak$`Emission (kg/d)`[Aug18Leak$`Vent/Leak` == "Leak"])

# calculate cumulative emissions contribution of each leak emitter to total leak emissions
Aug19Leak <- Aug19 %>% 
  # select leak emissions
  filter(`Vent/Leak` == "Leak") %>% 
  # calculate cumulative percentage of leak emissions
  mutate(EmissionPerc = cumsum(`Emission (kg/d)`)/sum(`Emission (kg/d)`))

# calculate cumulative emitter contribution of leak emissions
Aug19Leak <- Aug19Leak %>% 
  mutate(EmitterPerc = seq.int(nrow(Aug19Leak))/nrow(Aug19Leak))

# leak emissions contribution from top 5% of total leak emissions
sum(Aug19Leak$`Emission (kg/d)`[Aug19Leak$EmitterPerc < 0.05 & Aug19Leak$`Vent/Leak` == "Leak"])/sum(Aug19Leak$`Emission (kg/d)`[Aug19Leak$`Vent/Leak` == "Leak"])
###

# vent average emissions in 2018 and 2019
mean(Aug18$`Emission (kg/d)`[Aug18$`Vent/Leak` == "Vent"])
mean(Aug19$`Emission (kg/d)`[Aug19$`Vent/Leak` == "Vent"])

# emissions reduction from large vent emissions (>100 kg/d) over total emissions reduction - showing that reductions from large vents is the main driver of leak emissions reduction
(sum(Aug18$`Emission (kg/d)`[Aug18$`Vent/Leak` == "Vent" & Aug18$`Emission (kg/d)` > 100]) - sum(Aug19$`Emission (kg/d)`[Aug19$`Vent/Leak` == "Vent" & Aug19$`Emission (kg/d)` > 100]))/(sum(Aug18$`Emission (kg/d)`[Aug18$`Vent/Leak` == "Vent"]) - sum(Aug19$`Emission (kg/d)`[Aug19$`Vent/Leak` == "Vent"]))

Aug18 %>% # count of large vent emissions (>100 kg/d)
  # select vent emissions that are > 100 kg/d
  filter(`Vent/Leak` == "Vent" & `Emission (kg/d)` > 100) %>% 
  # count number of vent emissions
  summarise(Count = n())

Aug19 %>% # count of large vent emissions (>100 kg/d)
  # select vent emissions that are > 100 kg/d
  filter(`Vent/Leak` == "Vent" & `Emission (kg/d)` > 100) %>% 
  # count number of vent emissions
  summarise(Count = n())

# emissions reduction from large vent emissions (>100 kg/d)
(sum(Aug18$`Emission (kg/d)`[Aug18$`Vent/Leak` == "Vent" & Aug18$`Emission (kg/d)`>100]) - sum(Aug19$`Emission (kg/d)`[Aug19$`Vent/Leak` == "Vent" & Aug19$`Emission (kg/d)`>100]))/sum(Aug18$`Emission (kg/d)`[Aug18$`Vent/Leak` == "Vent" & Aug18$`Emission (kg/d)`>100])
```

```{r}
# Results section:
# Tanks are the single largest source of methane emissions, contributin gto 58% of total emissions in 2019

Aug18 %>% # emissions reduction by component 
  # combine two data sets
  rbind(Aug19) %>% 
  # group data by survey and component
  group_by(Survey, `Emitting Component`) %>% 
  # calculate the average of each component in each survey
  summarise(Average = mean(`Emission (kg/d)`)) %>% 
  # transform data format from long to wide
  spread(Survey, Average) %>% 
  # calculate emissions reduction of each component
  mutate(ChangePerc = (`Survey 5` - `Survey 1`)/`Survey 1`)

Aug18 %>% # count reduction of non-tank related open-ended line 
  # combine two data sets
  rbind(Aug19) %>% 
  # select non-tank related open-ended line
  filter(`Emitting Component` == "Open-Ended Line (Non-Tank)") %>% 
  # group emissions by survey
  group_by(Survey) %>% 
  # count number of emitters in each survey
  summarise(Count = n()) %>% 
  # transofrm data from long to wide format
  spread(Survey, Count) %>% 
  # calculate change in count
  mutate(CountChange = (`Survey 5` - `Survey 1`)/`Survey 1`)

Aug18 %>% # emissions reduction of non-tank related open-ended line 
  # combine two data sets
  rbind(Aug19) %>% 
  # select non-tank related open-ended line
  filter(`Emitting Component` == "Open-Ended Line (Non-Tank)") %>% 
  # group emissions by survey
  group_by(Survey) %>% 
  # calculate emissions sum from two surveys
  summarise(Sum = sum(`Emission (kg/d)`)) %>% 
  # transofrm data from long to wide format
  spread(Survey, Sum) %>% 
  # calculate change in count
  mutate(SumChange = (`Survey 5` - `Survey 1`)/`Survey 1`)

Aug18 %>% # count of large pneumatics emissions (>100) from two surveys
  # combine the two data set
  rbind(Aug19) %>% 
  # select large pneumatics emissions (>100 kg/d)
  filter(`Emitting Component` == "Pneumatics" & `Emission (kg/d)` > 100) %>% 
  # group by survey
  group_by(Survey) %>% 
  # count number of emitters
  summarise(Count = n())

Aug18 %>% # total emissions from large pneumatics emissions (>100)
  # combine the two data set
  rbind(Aug19) %>% 
  # select large pneumatics emissions (>100 kg/d)
  filter(`Emitting Component` == "Pneumatics" & `Emission (kg/d)` > 100) %>% 
  # group by survey
  group_by(Survey) %>% 
  # calculate total emissions
  summarise(Sum = sum(`Emission (kg/d)`)) %>% 
  # transform data from long to wide format
  spread(Survey, Sum) %>% 
  # calculate total emissions reduction 
  mutate(SumChange = (`Survey 5` - `Survey 1`)/`Survey 1`)

Aug18 %>% # tank emissions contribution to total emissions
  # combine two data sets
  rbind(Aug19) %>% 
  # group by survey and whether the emission is tank-related or not
  group_by(Survey, `Tank Relation`) %>% 
  # calculate total emission of tank and non-tank related emissions
  summarise(Sum = sum(`Emission (kg/d)`)) %>% 
  # transform data set from long to wide format
  spread(`Tank Relation`, Sum) %>% 
  # calculate tank emissions % to total emissions
  mutate(TankEmission = Yes/(Yes+No))

Aug18 %>% # count of tank emissions contribution to total counts
  # combine two data sets
  rbind(Aug19) %>% 
  # group by survey and whether the emission is tank-related or not
  group_by(Survey, `Tank Relation`) %>% 
  # calculate count of tank and non-tank related emissions
  summarise(Count = n()) %>% 
  # transform data set from long to wide format
  spread(`Tank Relation`, Count) %>% 
  # calculate count of tank emissions % to total count
  mutate(TankEmission = Yes/(Yes+No))

Aug19 %>% # average tank emissions compared to non-tank emissions
  # group emitters by tank or non-tank
  group_by(Survey, `Tank Relation`) %>%
  # calcute the average of tank and non-tank emissions
  summarise(Average = mean(`Emission (kg/d)`)) %>% 
  # transform data set from long to wide format
  spread(`Tank Relation`, Average)
```

```{r}
# Results section:
# Emissions from oil sites and multi-well batteries, on average, are more than two times that of emissions from gas sites and single-well batteries, respectively.

site %>% #count of sites in each survey - only sites that are consistently visited are included
  # group sites by survey
  group_by(Survey) %>%
  # count number of sites in each survey
  tally()

site %>% # number of non-emitting sites in Aug 2018 survey
  filter(Survey == "Survey 1" & `Emissions (kg/d)` == 0) %>% 
  tally()

Aug18 %>% # count number of site that only have vent emissions 
  # summarize data set by site and emissions type
  group_by(Site, `Vent/Leak`) %>% 
  # calculate sum of vent or leak emissions for each site
  summarise(Sum = sum(`Emission (kg/d)`)) %>% 
  # transform data from long to wide format
  spread(`Vent/Leak`, Sum) %>% 
  # select site with zero leak emissions - vent only sites
  filter(is.na(Leak)) %>% 
  # count number of vent only sites
  nrow

site %>% # number of non-emitting sites in Aug 2019 survey
  filter(Survey == "Survey 5" & `Emissions (kg/d)` == 0) %>% 
  tally()

Aug19 %>% # count number of site that only have vent emissions 
  # summarize data set by site and emissions type
  group_by(Site, `Vent/Leak`) %>% 
  # calculate sum of vent or leak emissions for each site
  summarise(Sum = sum(`Emission (kg/d)`)) %>% 
  # transform data from long to wide format
  spread(`Vent/Leak`, Sum) %>% 
  # select site with zero leak emissions - vent only sites
  filter(is.na(Leak)) %>% 
  # count number of vent only sites
  nrow

# calculate the cumulative emissions of each site
Aug18Site <- site %>%
  # select August 2018 sites
  filter(Survey == 'Survey 1') %>% 
  # order the site descending by emission sizes
  arrange(-`Emissions (kg/d)`) %>% 
  # calculate the cumulative emissions of each site
  mutate(EmissionPerc = cumsum(`Emissions (kg/d)`)/sum(`Emissions (kg/d)`))

# calculate the cumulative emitter of each site 
Aug18Site <- Aug18Site %>% 
  mutate(EmitterPerc = seq.int(nrow(Aug18Site))/nrow(Aug18Site))

# calculate the cumulative emissions of each site
Aug19Site <- site %>%
  # select August 2019 sites
  filter(Survey == 'Survey 5') %>% 
  # order the site descending by emission sizes
  arrange(-`Emissions (kg/d)`) %>% 
  # calculate the cumulative emissions of each site
  mutate(EmissionPerc = cumsum(`Emissions (kg/d)`)/sum(`Emissions (kg/d)`))

# calculate the cumulative emitter of each site 
Aug19Site <- Aug19Site %>% 
  mutate(EmitterPerc = seq.int(nrow(Aug19Site))/nrow(Aug19Site))

Aug19Site %>% # contribution of top 5% of sites
  # select top 5% of sites
  filter(EmitterPerc < 0.05) %>%
  # select the cutoff row of the filtered data
  filter(row_number() == nrow(.)) %>% 
  # select the cumulative emission percentage and emission size for the cutoff top 5%
  select(EmissionPerc, `Emissions (kg/d)`)

Aug19Site %>% # cutoff emission size for 90% of total emissions 
  # select 90% total emissions from rank ordered emitters
  filter(EmissionPerc < 0.9) %>% 
  # find cutoff emitter row
  filter(row_number() == nrow(.)) %>% 
  # select the cutoff emission size
  select(`Emissions (kg/d)`)

site %>% # average site level emissions reduction from 2018 to 2019
  # group sites by survey
  group_by(Survey) %>% 
  # calculate the site level mean emissions in each survey
  summarise(Average = mean(`Emissions (kg/d)`)) %>% 
  # transform data from long to wide format
  spread(Survey, Average) %>% 
  # calculate the percentage change in average emissions
  mutate(Change = (`Survey 5` - `Survey 1`)/`Survey 1`)

data %>% # % of vent emissions to total emissions by each site type - August 2019
  # group data by survey, site type and vent or leak emissions 
  group_by(Survey, Site.Type, `Vent/Leak`) %>% 
  # calculate the sum of leak and vent emissions
  summarise(Sum = sum(`Emission (kg/d)`)) %>% 
  # select August 2019 survey and remove one site type (please refer to SI for more details)
  filter(Survey == "Survey 5", Site.Type != "Large Facility w/ Gathering System") %>% 
  # transform data from long to wide format
  spread(`Vent/Leak`, Sum) %>% 
  # calculate vent emissions % to total emissions
  mutate(VentPerc = Vent/(Vent + Leak))

data %>% # % of vent emissions to total emissions by each site type - August 2018
  # group data by survey, site type and vent or leak emissions 
  group_by(Survey, Site.Type, `Vent/Leak`) %>% 
  # calculate the sum of leak and vent emissions
  summarise(Sum = sum(`Emission (kg/d)`)) %>% 
  # select August 2018 survey and remove one site type (please refer to SI for more details)
  filter(Survey == "Survey 1", Site.Type != "Large Facility w/ Gathering System") %>% 
  # transform data from long to wide format
  spread(`Vent/Leak`, Sum) %>% 
  # calculate vent emissions % to total emissions
  mutate(VentPerc = Vent/(Vent + Leak))

data %>% # count of emitters by site type in 2018 and 2019 surveys
  # remove site type that is not included in site level analysis - refer to SI S1.2
  filter(Site.Type != "Large Facility w/ Gathering System") %>% 
  # group by survey and site type
  group_by(Survey, Site.Type) %>%
  # calculate total count of emitter counts for each site type
  summarise(TotalEmitter = n()) %>% 
  # import count of sites for each site type
  left_join(., siteCount) %>% 
  # calculte average number of emitters per site by site type
  mutate(EmitterPerSite = TotalEmitter/n)

data %>% # count of emitters per site in 2018 and 2019 survey
  # remove site type that is not included in site level analysis - refer to SI S1.2
  filter(Site.Type != "Large Facility w/ Gathering System") %>% 
  # group by survey
  group_by(Survey) %>%
  # calcuate average number of emitters per site - there are 148 sites in each survey
  summarise(EmitterPerSite = n()/148)

site %>% # site level total emissions reduction from 2018 to 2019 (148 sites that are measured on schedule - please refer to SI Section S1.2)
  # group by survey
  group_by(Survey) %>% 
  # calculate total emissions measured at each survey
  summarise(TotalEmissions = sum(`Emissions (kg/d)`)) %>% 
  # transform data from long to wide format
  spread(Survey, TotalEmissions) %>% 
  # calculate change in total emissions 
  mutate(Change = (`Survey 5` - `Survey 1`)/`Survey 1`)

data %>% # count of emitter change from 2018 to 2019
  # remove site type that is not included in site level analysis - refer to SI S1.2
  filter(Site.Type != "Large Facility w/ Gathering System") %>% 
  # group by survey and site type
  group_by(Survey, Site.Type) %>%
  # calculate total count of emitter counts for each site type
  summarise(TotalEmitter = n()) %>% 
  # import count of sites for each site type
  left_join(., siteCount) %>% 
  # calculate average number of emitters per site by site type
  mutate(EmitterPerSite = TotalEmitter/n) %>% 
  # select columns necessary for further analysis
  select(Survey, Site.Type, EmitterPerSite) %>% 
  # transform data from long to wide format
  spread(Survey, EmitterPerSite) %>% 
  # calculate change in count of emitters from 2018 to 2019
  mutate(Change = `Survey 5` - `Survey 1`)

site %>% # emission comparison between oil producing and gas producing sites
  # group sites by oil or gas producing site
  group_by(Survey, OilGas) %>% 
  # calculate the average emission per site
  summarise(Average = mean(`Emissions (kg/d)`)) %>% 
  # transform data from long to wide format
  spread(Survey, Average) %>% 
  # calculate average emission change from 2018 to 2019
  mutate(Change = (`Survey 5` - `Survey 1`)/`Survey 1`)

site %>% # emission comparison between multiwell and single-well sites
  # group sites by multiwell or single-well sites
  group_by(Survey, MWSW) %>% 
  # calculate the average emission per site
  summarise(Average = mean(`Emissions (kg/d)`)) %>% 
  # transform data from long to wide format
  spread(Survey, Average) %>% 
  # calculate average emission change from 2018 to 2019
  mutate(Change = (`Survey 5` - `Survey 1`)/`Survey 1`)

site %>% # emission comparison between multiwell and single-well sites
  # group sites by multiwell or single-well sites
  group_by(Survey, Site.Type) %>% 
  # calculate the average emission per site
  summarise(Average = mean(`Emissions (kg/d)`)) %>% 
  # transform data from long to wide format
  spread(Survey, Average) %>% 
  # calculate average emission change from 2018 to 2019
  mutate(Change = (`Survey 5` - `Survey 1`)/`Survey 1`)

site %>% # emission reduction from Gas MW sites
  # select Gas MW sites
  filter(Site.Type == "Gas MW") %>%
  # select columns necessary for further analysis
  select(Survey, Site, `Emissions (kg/d)`) %>% 
  # transform data from long to wide format
  spread(Survey, `Emissions (kg/d)`) %>% 
  # calculate change in emissions from 2018 to 2019
  mutate(Change = `Survey 5` - `Survey 1`) %>% 
  # order data descendingly by emissions reduction from 2018 to 2019
  arrange(`Change`) %>% 
  # select sites that see reduction in 2019 survey
  filter(Change < 0) %>% 
  # calculate the cumulative percentage of emissions reduction by each site
  mutate(CumChange = cumsum(Change)/sum(Change))

site %>% # emission reduction from Gas SW sites
  # select Gas SW sites
  filter(Site.Type == "Gas SW") %>%
  # select columns necessary for further analysis
  select(Survey, Site, `Emissions (kg/d)`) %>% 
  # transform data from long to wide format
  spread(Survey, `Emissions (kg/d)`) %>% 
  # calculate change in emissions from 2018 to 2019
  mutate(Change = `Survey 5` - `Survey 1`) %>% 
  # order data descendingly by emissions reduction from 2018 to 2019
  arrange(`Change`) %>% 
  # select sites that see reduction in 2019 survey
  filter(Change < 0) %>% 
  # calculate the cumulative percentage of emissions reduction by each site
  mutate(CumChange = cumsum(Change)/sum(Change))

site %>% # emission reduction from Oil MW sites
  # select Oil MW sites
  filter(Site.Type == "Oil MW") %>%
  # select columns necessary for further analysis
  select(Survey, Site, `Emissions (kg/d)`) %>% 
  # transform data from long to wide format
  spread(Survey, `Emissions (kg/d)`) %>% 
  # calculate change in emissions from 2018 to 2019
  mutate(Change = `Survey 5` - `Survey 1`) %>% 
  # order data descendingly by emissions reduction from 2018 to 2019
  arrange(`Change`) %>% 
  # select sites that see reduction in 2019 survey
  filter(Change < 0) %>% 
  # calculate the cumulative percentage of emissions reduction by each site
  mutate(CumChange = cumsum(Change)/sum(Change))

site %>% # calculate energy-based proportional loss rate
  # remove sites that we cannot find production data on 
  filter(`Production Gas` != "NA" & `Production Oil` != "NA") %>% 
  # convert gas and oil production energy to numeric values
  mutate(`Production Gas Energy` = as.numeric(`Production Gas Energy`), `Production Oil Energy` = as.numeric(`Production Oil Energy`)) %>% 
  # group by survey
  group_by(Survey) %>%
  # calculate energy based proportional loss rate
  summarise(PLRe = sum(`Emission Energy`)/(sum(`Production Gas Energy`) + sum(`Production Oil Energy`)))

site %>% # calculate energy-based proportional loss rate in 2019
  # remove sites that we cannot find production data on 
  filter(`Production Gas` != "NA" & `Production Oil` != "NA" & Survey == "Survey 5") %>% 
  # convert gas and oil production energy to numeric values
  mutate(`Production Gas Energy` = as.numeric(`Production Gas Energy`), `Production Oil Energy` = as.numeric(`Production Oil Energy`)) %>% 
  # group by oil producing or gas-producing site
  group_by(OilGas) %>%
  # calculate energy based proportional loss rate
  summarise(PLRe = sum(`Emission Energy`)/(sum(`Production Gas Energy`) + sum(`Production Oil Energy`)))

site %>% # compare site level energy production between single-well and multiwell sites
  # remove sites that we cannot find production data on 
  filter(`Production Gas` != "NA" & `Production Oil` != "NA" & Survey == "Survey 5") %>% 
  # convert gas and oil production energy to numeric values
  mutate(`Production Gas Energy` = as.numeric(`Production Gas Energy`), `Production Oil Energy` = as.numeric(`Production Oil Energy`)) %>% 
  # calculate total energy produced by each site
  mutate(TotalEnergy = `Production Gas Energy` + `Production Oil Energy`) %>% 
  # group by multiwell or single-well site
  group_by(MWSW) %>%
  # calculate energy based proportional loss rate
  summarise(ProductionEnergy = mean(TotalEnergy)) %>% 
  # transform data from long to wide format
  spread(MWSW, ProductionEnergy) %>% 
  # compare energy production numbers between multiwell adn single-well
  mutate(Comparison = MW/SW)

site %>% # calculate energy-based proportional loss rate in 2019
  # remove sites that we cannot find production data on 
  filter(`Production Gas` != "NA" & `Production Oil` != "NA" & Survey == "Survey 5") %>% 
  # convert gas and oil production energy to numeric values
  mutate(`Production Gas Energy` = as.numeric(`Production Gas Energy`), `Production Oil Energy` = as.numeric(`Production Oil Energy`)) %>% 
  # group by multiwell or single-well site
  group_by(MWSW) %>%
  # calculate energy based proportional loss rate
  summarise(PLRe = sum(`Emission Energy`)/(sum(`Production Gas Energy`) + sum(`Production Oil Energy`)))
```

```{r}
# Results section:
# Time series analysis of surveys demonstrate high degree of repair effectiveness both at the component and site-level - repaired leaks do not emit in subsequent surveys. 

tagged %>% # only component with more than 20 tagged leaks are selected for analysis
  # group by component and repaired status
  group_by(Component, Repaired) %>% 
  # count number of component
  tally()

tagged %>% # emissions change based on repaired status and component
  # select components for comparison
  filter(Component %in% c("Flange/Connector","Pneumatics", "Valves")) %>% 
  # group by component and repaired status
  group_by(Component, Repaired) %>% 
  # calculate average emissions from initial and followup surveys
  summarise(Initial = mean(`Initial Survey Emissions (kg/d)`), Followup = mean(`Follow-up Survey Emissions (kg/d)`)) %>% 
  # calculate change in emissions
  mutate(Change = Followup - Initial)

tagged %>% # one large increase in emitter contribute to majority of average emissions increase in pneumatics
  # select pneumatics
  filter(Component == "Pneumatics" & Repaired == "No") %>% 
  # calculate emissions change bettwen inital and followup survey
  mutate(Change = `Follow-up Survey Emissions (kg/d)` - `Initial Survey Emissions (kg/d)`) %>% 
  # order change from large to small (positive first)
  arrange(-Change) %>% 
  # filter emitters with emissions increase
  filter(Change >0) %>% 
  # calculate the cumulative percentage of emissions increase for each emitter
  mutate(Cumsum = cumsum(Change)/sum(Change))

tagged %>% # impact of one large emissions increase to Pneumatics
  # select non-repaired pneumatics
  filter(Component == "Pneumatics" & Repaired == "No") %>% 
  # calculate emissions changes from initial to followup surveys
  mutate(Change = `Follow-up Survey Emissions (kg/d)` - `Initial Survey Emissions (kg/d)`) %>% 
  # order change from large to small (positive first)
  arrange(-Change) %>% 
  # remove emitter associated with largest emission increase 
  slice(-1) %>% 
  # calculate average emissions from initial and followup surveys
  summarise(Initial = mean(`Initial Survey Emissions (kg/d)`), Followup = mean(`Follow-up Survey Emissions (kg/d)`))
```
```{r}
# Results section:
# LDAR surveys are effective at reducing leak emissions: the average number of leaks at treatment sites are significantly lower than those at control sites, while the average number of vents do not change. 

repaired %>% # count of sites in each repaired status group
  # group by repaired status
  group_by(`Repaired Status`) %>%
  # count of each group
  tally()

repaired %>% # count of site in each treatment group
  # group by repaired status and treatment group
  group_by(`Repaired Status`, Treatment.Group) %>%
  # count of each group
  tally()

leakCount <- data %>% #calculate the count of leaks for each site
  # select leak data and site types
  filter(Site.Type != "Large Facility w/ Gathering System" & `Vent/Leak` == "Leak") %>% 
  # group by survey and site
  group_by(Survey, Site) %>%
  # count number of leaks for each site
  summarise(Count = n()) %>% 
  # transform data from long to wide format
  spread(Survey, Count) %>% 
  # replace na with 0
  replace_na(list(`Survey 1` = 0, `Survey 5` = 0))

ventCount <- data %>% #calculate the count of vents for each site
  # select vent data and site types
  filter(Site.Type != "Large Facility w/ Gathering System" & `Vent/Leak` == "Vent") %>% 
  # group by survey and site
  group_by(Survey, Site) %>% 
  # count number of vents for each site
  summarise(Count = n()) %>% 
  # transform data from long to wide format
  spread(Survey, Count) %>% 
  # replace na with 0
  replace_na(list(`Survey 1` = 0, `Survey 5` = 0))

repairedCount <- repaired %>% # count of leak and vent at each site with repaired status
  # import leak count numbers
  left_join(., leakCount) %>%
  # rename columns
  rename(`Survey 1 Leak` = `Survey 1`, `Survey 5 Leak` = `Survey 5`) %>% 
  # replace na with 0
  replace_na(list(`Survey 1 Leak` = 0, `Survey 5 Leak` = 0)) %>% 
  # import vent count numbers
  left_join(., ventCount) %>% 
  # rename columns
  rename(`Survey 1 Vent` = `Survey 1`, `Survey 5 Vent` = `Survey 5`) %>% 
  # replace na with 0
  replace_na(list(`Survey 1 Vent` = 0, `Survey 5 Vent` = 0))

repairedCount %>% # calculate average count of leak based on repaired status
  # group by repaired status
  group_by(`Repaired Status`) %>% 
  # calculate average count of leaks
  summarise(InitalLeak = mean(`Survey 1 Leak`), FollowupLeak = mean(`Survey 5 Leak`))

repairedCount %>% # calculate average count of vent based on repaired status
  # group by repaired status
  group_by(`Repaired Status`) %>% 
  # calculate average count of vents
  summarise(InitalVent = mean(`Survey 1 Vent`), FollowupLeak = mean(`Survey 5 Vent`))

# site 104 is the control site that accidentally went through repair
site %>% # calculate total emission change in control group
  # select survey and treatment group, remove site that was accidentally repaired
  filter(Survey %in% c("Survey 1", "Survey 5") & Site != 104 & Treatment.Group == "Control") %>% 
  # group by survey
  group_by(Survey) %>% 
  # calculate total emissions
  summarise(TotalEmission = sum(`Emissions (kg/d)`)) %>% 
  # transform data from long to wide format
  spread(Survey, TotalEmission) %>% 
  # calculate % change in emissions
  mutate(Change = (`Survey 5` - `Survey 1`)/`Survey 1`)

data %>% # calculate leak and vent emission change in control group
  # select survey and treatment group, remove site that was accidentally repaired
  filter(Survey %in% c("Survey 1", "Survey 5") & Site != 104 & Treatment.Group == "Control" & Site.Type != "Large Facility w/ Gathering System") %>% 
  # group by survey and emission type
  group_by(Survey, `Vent/Leak`) %>% 
  # calculate total emissions
  summarise(Total = sum(`Emission (kg/d)`)) %>% 
  # transform data from long to wide format
  spread(Survey, Total) %>% 
  # calculate % change in emissions
  mutate(Change = (`Survey 5` - `Survey 1`)/`Survey 1`)

data %>% # calculate emissions change from leaks >100 in control group
  # select survey, treatment group and emission type, remove site that was accidentally repaired
  filter(Survey %in% c("Survey 1", "Survey 5") & Site != 104 & Treatment.Group == "Control" & Site.Type != "Large Facility w/ Gathering System" & `Vent/Leak` == "Leak") %>% 
  # group by survey
  group_by(Survey) %>% 
  # calculate total emissions from all leaks and total emissions from leaks >100
  summarise(Total = sum(`Emission (kg/d)`), TotalLarge = sum(`Emission (kg/d)`[`Emission (kg/d)`>100])) %>% 
  # transform data to long format
  gather(Group, TotalEmission, Total:TotalLarge) %>% 
  # transform data from long to wide format
  spread(Survey, TotalEmission) %>% 
  # calculate emission change 
  mutate(Change = `Survey 5` - `Survey 1`)

```





















